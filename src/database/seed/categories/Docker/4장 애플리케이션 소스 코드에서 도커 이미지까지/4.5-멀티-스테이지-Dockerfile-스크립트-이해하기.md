---
title: "4.5 멀티 스테이지 Dockerfile 스크립트 이해하기"
categoryPath:
  - "Docker"
  - "4장 애플리케이션 소스 코드에서 도커 이미지까지"
  - "4.5 멀티 스테이지 Dockerfile 스크립트 이해하기"
authorNick: "관리자"
createdAt: "2025-08-27"
updateMode: "upsert"
---

# 4.5 멀티 스테이지 Dockerfile 심화 이해

멀티 스테이지 빌드는 Docker의 핵심 기능 중 하나로, 빌드와 런타임 환경을 분리하여 이미지 크기를 획기적으로 줄이고 보안을 강화할 수 있습니다. 지금까지 Java, Node.js, Go에서 사용한 멀티 스테이지의 원리와 고급 활용법을 학습합니다.

## 멀티 스테이지 빌드 원리

### 기본 개념

멀티 스테이지 빌드는 하나의 Dockerfile에서 여러 개의 FROM 구문을 사용하여 각각 다른 용도의 이미지를 생성합니다.

```dockerfile
# 빌드용 스테이지
FROM node:18 AS build
# 빌드 작업들...

# 실행용 스테이지  
FROM nginx:alpine AS production
COPY --from=build /app/dist /usr/share/nginx/html
```

### 작동 방식

1. **스테이지 분리**: 각 FROM은 새로운 스테이지 시작
2. **선택적 복사**: --from 플래그로 특정 스테이지에서 파일 복사
3. **최종 이미지**: 마지막 스테이지만 최종 이미지로 생성
4. **중간 정리**: 이전 스테이지는 자동으로 정리됨

## 실전 멀티 스테이지 패턴

### 1. 기본 빌드-실행 분리

```dockerfile
# === 빌드 스테이지 ===
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src/ src/
RUN mvn package -DskipTests

# === 실행 스테이지 ===
FROM eclipse-temurin:17-jre-alpine
COPY --from=build /app/target/*.jar app.jar
EXPOSE 8080
CMD ["java", "-jar", "app.jar"]
```

### 2. 테스트 통합 패턴

```dockerfile
# === 의존성 스테이지 ===
FROM node:18-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci

# === 개발 의존성 스테이지 ===
FROM deps AS dev-deps
RUN npm ci --include=dev

# === 테스트 스테이지 ===
FROM dev-deps AS test
COPY . .
RUN npm run test
RUN npm run lint

# === 빌드 스테이지 ===
FROM test AS build
RUN npm run build

# === 프로덕션 스테이지 ===
FROM nginx:alpine AS production
COPY --from=build /app/dist /usr/share/nginx/html
```

### 3. 조건부 빌드 패턴

```dockerfile
# === 베이스 ===
FROM node:18-alpine AS base
WORKDIR /app
COPY package*.json ./

# === 개발 환경 ===
FROM base AS development
RUN npm install
COPY . .
EXPOSE 3000
CMD ["npm", "run", "dev"]

# === 프로덕션 빌드 ===
FROM base AS production-build
RUN npm ci --only=production
COPY . .
RUN npm run build

# === 프로덕션 실행 ===
FROM nginx:alpine AS production
COPY --from=production-build /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

## 고급 멀티 스테이지 기법

### 빌드 인수 활용

```dockerfile
ARG BUILD_ENV=production
ARG NODE_VERSION=18

FROM node:${NODE_VERSION}-alpine AS base

# 환경별 다른 처리
FROM base AS build-dev
RUN echo "개발 환경 빌드"

FROM base AS build-prod  
RUN echo "프로덕션 환경 빌드"

# 조건부 선택
FROM build-${BUILD_ENV} AS final
```

### 병렬 빌드 최적화

```dockerfile
# === 공통 베이스 ===
FROM alpine AS base
RUN apk add --no-cache ca-certificates

# === 프론트엔드 빌드 ===
FROM node:18-alpine AS frontend
WORKDIR /app
COPY frontend/ .
RUN npm ci && npm run build

# === 백엔드 빌드 ===  
FROM golang:1.22-alpine AS backend
WORKDIR /app
COPY backend/ .
RUN go build -o server

# === 최종 조합 ===
FROM base AS final
COPY --from=frontend /app/dist /static
COPY --from=backend /app/server /
EXPOSE 8080
CMD ["/server"]
```

## 캐시 최적화 전략

### 레이어 순서 최적화

```dockerfile
FROM node:18-alpine AS build

WORKDIR /app

# 1. 의존성 파일 먼저 (변경 빈도 낮음)
COPY package*.json ./
RUN npm ci

# 2. 설정 파일들
COPY tsconfig.json webpack.config.js ./

# 3. 소스 코드 (변경 빈도 높음)
COPY src/ src/
COPY public/ public/

# 4. 빌드 실행
RUN npm run build
```

### BuildKit 캐시 마운트

```dockerfile
FROM golang:1.22-alpine AS builder

WORKDIR /app

COPY go.mod go.sum ./

# 모듈 캐시 마운트
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download

COPY . .

# 빌드 캐시 마운트
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go build -o app
```

## 특정 스테이지만 빌드하기

### 개발 환경용 빌드

```bash
# 개발 스테이지까지만 빌드
docker build --target development -t myapp:dev .

# 테스트 스테이지까지만 빌드
docker build --target test -t myapp:test .

# 프로덕션 빌드 (기본)
docker build -t myapp:prod .
```

### 환경별 이미지 생성

```bash
# 환경 변수로 빌드 제어
docker build --build-arg BUILD_ENV=dev --target final -t myapp:dev .
docker build --build-arg BUILD_ENV=prod --target final -t myapp:prod .
```

## 실제 프로젝트 예시

### 풀스택 웹 애플리케이션

```dockerfile
# === Node.js 백엔드 빌드 ===
FROM node:18-alpine AS backend-build
WORKDIR /app/backend
COPY backend/package*.json ./
RUN npm ci --only=production
COPY backend/ .

# === React 프론트엔드 빌드 ===
FROM node:18-alpine AS frontend-build
WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ .
RUN npm run build

# === 프로덕션 조합 ===
FROM node:18-alpine AS production

# 백엔드 설정
WORKDIR /app
COPY --from=backend-build /app/backend/node_modules ./node_modules
COPY --from=backend-build /app/backend/src ./src
COPY --from=backend-build /app/backend/package.json ./

# 프론트엔드 정적 파일
COPY --from=frontend-build /app/frontend/build ./public

# 실행
EXPOSE 3000
CMD ["node", "src/server.js"]
```

### Go + React 조합

```dockerfile
# === React 빌드 ===
FROM node:18-alpine AS react-build
WORKDIR /app
COPY web/ .
RUN npm ci && npm run build

# === Go 빌드 ===
FROM golang:1.22-alpine AS go-build
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY *.go ./
COPY --from=react-build /app/build ./web/build
RUN CGO_ENABLED=0 go build -o server

# === 최종 이미지 ===
FROM scratch
COPY --from=go-build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=go-build /app/server /server
EXPOSE 8080
ENTRYPOINT ["/server"]
```

## 멀티 스테이지 디버깅

### 중간 스테이지 검사

```bash
# 특정 스테이지의 이미지 생성
docker build --target build -t debug:build .

# 중간 결과 확인
docker run --rm -it debug:build /bin/sh

# 레이어별 크기 확인
docker history debug:build
```

### 빌드 로그 상세 보기

```bash
# 빌드 과정 상세 로그
docker build --progress=plain .

# 빌드 캐시 무시
docker build --no-cache .
```

## 성능 측정 및 최적화

### 빌드 시간 측정

```bash
#!/bin/bash
echo "멀티 스테이지 빌드 성능 테스트"

echo "1. 전체 빌드 시간:"
time docker build -t app:full .

echo "2. 캐시 활용 재빌드:"
echo "# 소스 수정 시뮬레이션" >> src/main.js
time docker build -t app:cached .

echo "3. 특정 스테이지만 빌드:"
time docker build --target build -t app:build-only .
```

### 최적화 체크리스트

#### 구조 최적화
- [ ] 변경 빈도에 따른 레이어 순서 조정
- [ ] 의존성과 소스 코드 분리
- [ ] 불필요한 파일 제외 (.dockerignore)
- [ ] 각 스테이지의 명확한 역할 정의

#### 캐시 최적화
- [ ] BuildKit 캐시 마운트 활용
- [ ] 멀티 플랫폼 빌드 캐시 고려
- [ ] CI/CD에서 레지스트리 캐시 활용

#### 보안 최적화
- [ ] 최종 스테이지에 빌드 도구 제외
- [ ] 민감 정보 중간 스테이지에만 포함
- [ ] 최소 권한 사용자로 실행

## 멀티 스테이지 vs 단일 스테이지 비교

| 항목 | 단일 스테이지 | 멀티 스테이지 | 개선율 |
|------|--------------|---------------|--------|
| 이미지 크기 | 1.2GB | 50MB | 96% |
| 빌드 시간 (첫 빌드) | 5분 | 5분 | 0% |
| 빌드 시간 (재빌드) | 5분 | 30초 | 90% |
| 보안 취약점 | 높음 | 낮음 | - |

멀티 스테이지 빌드를 통해 이미지 크기를 대폭 줄이고, 빌드 캐시 효율성을 높이며, 보안을 강화할 수 있습니다.