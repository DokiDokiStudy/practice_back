---
title: "9.2 측정값 수집을 맡을 프로메테우스 컨테이너 실행하기"
categoryPath:
  - "Docker"
  - "9장 컨테이너 모니터링으로 투명성 있는 애플리케이션 만들기"
  - "9.2 측정값 수집을 맡을 프로메테우스 컨테이너 실행하기"
authorNick: "관리자"
createdAt: "2025-08-27"
updateMode: "upsert"
---

# 9.2 측정값 수집을 맡을 프로메테우스 컨테이너 실행하기
- prometheus 는 직접 측정값을 대상 시스템에서 받아서 수집하는 풀링 방식으로 동작합니다.
- prometheus 에서 측정값을 수집하는 과정을 스크래핑 이라고 합니다.
- 스크래핑을 하기 위해서는 대상 애플리케이션의 엔드포인트를 설정해야 합니다.

## Prometheus의 기본 개념 및 흐름
- **Pull 방식**: Prometheus가 각 타겟(컨테이너/서비스)의 메트릭 엔드포인트를 주기적으로 조회(scrape)
- **scrape_configs**: 어떤 타겟에서 어떤 경로로 메트릭을 수집할지 정의
- **job_name**: 논리적 그룹(서비스 단위 등) 지정
- **target**: 실제 메트릭을 제공하는 엔드포인트(예: http://app:8080/metrics)

### Prometheus 설정파일 구조 예시
```yaml
global:
  scrape_interval: 10s
scrape_configs:
  - job_name: "webapp"
    metrics_path: /metrics
    static_configs:
      - targets: ["webapp:8080"]
```

### 실제 모니터링 흐름
```
컨테이너/서비스 ──(메트릭 엔드포인트)──▶ Prometheus ──▶ Grafana(시각화)
                                 │
                                 └─▶ Alertmanager(알람)
```


```
global:
  scrape_interval: 10s

scrape_configs:
  - job_name: "image-gallery"
    metrics_path: /metrics
    static_configs:
      - targets: ["image-gallery"]

  - job_name: "iotd-api"
    metrics_path: /actuator/prometheus
    static_configs:
      - targets: ["iotd"]

  - job_name: "access-log"
    metrics_path: /metrics
    scrape_interval: 3s
    dns_sd_configs:
      - names:
          - accesslog
        type: A
        port: 80
        
  - job_name: "docker"
    metrics_path: /metrics
    static_configs:
      - targets: ["DOCKER_HOST:9323"]
```

- global scrape_interval 설정은 전체 대상의 스크래핑의 주기를 설정합니다. (10초)
- access-log 컨테이너의 경우 dns_sd_configs 설정을 통해 DNS 기반 서비스 디스커버리를 사용합니다.
- 그 이유는 access-log 의 경우 서버가 Scale Out 되어 있어 도커 DNS 를 통해 내부 IP 를 찾아서 통신하기 위함입니다.
- type: A 는 도메인 이름을 IPv4 주소로 매핑하는 것입니다.

```bash
$ docker compose -f docker-compose.yml up -d --scale accesslog=3

[+] Running 6/6
 ✔ Container exercises-prometheus-1     Started                                                                                                                                                               0.3s 
 ✔ Container exercises-accesslog-3      Started                                                                                                                                                               0.5s 
 ✔ Container exercises-accesslog-1      Started                                                                                                                                                               0.3s 
 ✔ Container exercises-accesslog-2      Started                                                                                                                                                               0.6s 
 ✔ Container exercises-iotd-1           Started                                                                                                                                                               0.3s 
 ✔ Container exercises-image-gallery-1  Started                 
 
$ for i in {1..10}; do curl <http://localhost:8010> > /dev/null; done
```

```prometheus
access_log_total
```

- 기본 설정이 되어있는 프로메테우스 이미지를 만들면 매번 추라고 설정을 작성하지 않아도 되며, 필요한 경우 기본값을 수정할 수 있습니다.
- 프로메테우스는 레이블을 붙여 메트릭에 대해 다양한 컨텍스트를 추가할 수 있습니다.
- 또한, 레이블을 이용해 프로메테우스 쿼리를 이용해 집계 및 분석이 가능합니다.


```prometheus
access_log_total{instance="172.20.0.6:80"}
```

```prometheus
sum(image_gallery_requests_total{code="200"}) without(instance)
```

## 측정값 시각화를 위한 그라파나 컨테이너 실행하기
- 측정값을 가공하는 것은 promethus 에서 진행하고, 가공된 측정값을 통해 대시보드를 구성하는 것은 grafana 를 사용합니다.
- 그라파나 대시보드는 애플리케이션의 핵심 정보를 다양한 수준에서 제공합니다.
- 시각화된 그래프는 PromQL(Prometheus Query Language) 로 작성된 단일 쿼리로 그려집니다.
- PromQL 강력하고 직관적인 방식으로 데이터를 필터링, 집계, 계산할 수 있도록 설계되어 있습니다.

```bash
$ hostIP=$(ip addr show enp0s5 | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}')

$ docker compose -f docker-compose-with-grafana.yml up -d --scale accesslog=3

[+] Running 10/10
 ✔ grafana Pulled                                                                                                                                                                                     11.6s 
   ✔ 29bddadc8f3f Pull complete                                                                                                                                                                        2.2s 
   ✔ d9b0d74c7b70 Pull complete                                                                                                                                                                        2.2s 
   ✔ 3fb7e7639feb Pull complete                                                                                                                                                                        2.5s 
   ✔ 3cd42e0f5101 Pull complete                                                                                                                                                                        8.0s 
   ✔ af31ba937280 Pull complete                                                                                                                                                                        8.0s 
   ✔ 7c7f1ccbce63 Pull complete                                                                                                                                                                        8.0s 
   ✔ fc130f9b4964 Pull complete                                                                                                                                                                        8.0s 
   ✔ ca4c94507a97 Pull complete                                                                                                                                                                        8.0s 
   ✔ a2a6b53e5a03 Pull complete                                                                                                                                                                        8.0s 
[+] Running 7/7
 ✔ Container exercises-accesslog-3      Started                                                                                                                                                        0.8s 
 ✔ Container exercises-prometheus-1     Started                                                                                                                                                        0.4s 
 ✔ Container exercises-accesslog-1      Started                                                                                                                                                        0.3s 
 ✔ Container exercises-accesslog-2      Started                                                                                                                                                        0.6s 
 ✔ Container exercises-iotd-1           Started                                                                                                                                                        0.3s 
 ✔ Container exercises-grafana-1        Started                                                                                                                                                        0.7s 
 ✔ Container exercises-image-gallery-1  Started           
 
 $ for i in {1..20}; do curl <http://localhost:8010> > /dev/null; done
```

### PromQl 예시
```prometheus
# 200 응답 count
sum(image_gallery_requests_total{code="200"}) without(instance)
```
- 성공적으로 처리된(HTTP 200) 요청의 총합을 집계합니다. 애플리케이션의 정상 응답 비율을 확인할 때 사용합니다.

```prometheus
# 현재 처리 중인 요청 수
sum(image_gallery_requests) without(instance)
```
- 현재 활성화되어 처리 중인 요청 수를 나타냅니다. 부하 상태(트래픽 급증 시점)를 파악할 수 있습니다.

```prometheus
# 메모리 사용량
go_memstats_bytes{job="image-gallery"}
```
- Go 런타임 기준으로 image-gallery 서비스가 점유하고 있는 메모리 양을 바이트 단위로 표시합니다. 메모리 누수 여부나 사용 추세를 파악할 수 있습니다.

```prometheus
# 고루틴 활성 수
sum(go_goroutines{job="image-gallery"}) without(instance)
```
- 현재 실행 중인 Go 루틴(경량 스레드)의 총 개수를 나타냅니다. 갑작스러운 루틴 증가 시 병목 또는 무한 루프 가능성을 진단할 수 있습니다.

- 대시보드의 그래프는 절대적인 값보다는 변화하는 추세에서 알 수 있는 정보가 많습니다.
- 평균값에서 수치가 크게 올라가는 순간이 언제인지를 파악하는것이 중요합니다.
- 컴포넌트의 측정값을 조합해 애플리케이션의 이상 현상과 상관관계를 찾아야 합니다.

## 투명성의 수준 향상
- 간단한 개념 검증 수준의 프로덕트에서 실제 서비스 수준으로 발전하기 위해서는 모니터링을 통한 투명성 확보가 필수입니다.
- 투명성이란 단순히 수치를 보는 것이 아니라, 문제 발생 시 ‘무슨 일이 일어나고 있는지’를 명확히 파악할 수 있는 상태를 의미합니다.

### 실무(운영 환경)에서 투명성을 확보하는 방법
1. 대시보드 구성
- 서비스 전반의 핵심 지표(응답시간, 에러율, 요청 수, CPU/메모리 사용량 등)를 한눈에 볼 수 있는 운영 대시보드를 만듭니다.
- Grafana에서 패널 단위로 애플리케이션, 인프라, 네트워크 메트릭을 구분해 구성하는 것이 이상적입니다.

2. 이상 탐지 및 알람(Alerts)
- Prometheus의 Alertmanager를 통해 SLA 위반, 에러율 급등, 트래픽 급증 등을 실시간 감지하고 Slack, Email, Webhook 등으로 알림을 전송합니다.
- 예: error_rate > 0.05 조건 시 경고 발송

3. 로그와 메트릭의 상호 연계
- 단순 메트릭만 보는 것이 아니라, 해당 시점의 로그(예: Loki, ELK)와 연계해 원인을 빠르게 파악합니다.
- 예: “응답시간 급증 → 특정 API 호출량 급등 → 에러 로그 증가”로 이어지는 패턴 확인

4. 시스템 및 비즈니스 레벨의 분리
- 인프라스트럭처(서버 자원, 네트워크 등)와 비즈니스 메트릭(주문 수, 결제 성공률 등)을 구분해 관리하면 원인 분석이 용이합니다.
- 둘의 상관관계를 통해 “어떤 문제로 고객 경험이 악화되었는가”를 파악할 수 있습니다.

## 퀴즈
### Q1. Prometheus가 메트릭을 수집하는 기본 방식은?
- A) Push 방식
- B) Pull 방식
- C) Manual 방식
- D) File Import

<details>
<summary>정답 보기</summary>
<b>정답: B) Pull 방식</b><br>
Prometheus는 기본적으로 각 타겟의 엔드포인트를 주기적인 Pull 방식으로 메트릭을 수집합니다.
</details>
</details>

### Q2. Prometheus 설정파일에서 여러 서비스의 메트릭 수집 대상을 정의하는 항목은?
- A) job_name
- B) scrape_configs
- C) global
- D) static_configs

<details>
<summary>정답 보기</summary>
<b>정답: B) scrape_configs</b><br>
여러 서비스의 메트릭 수집 대상을 정의하는 항목은 scrape_configs입니다.
</details>

### Q3. 다음 중 Prometheus와 Grafana의 역할 설명으로 옳은 것은?
- A) Prometheus는 시각화, Grafana는 메트릭 수집
- B) Prometheus는 알람만 관리
- C) Prometheus는 메트릭 수집/저장, Grafana는 시각화
- D) 둘 다 메트릭 수집만 담당

<details>
<summary>정답 보기</summary>
<b>정답: C) Prometheus는 메트릭 수집/저장, Grafana는 시각화</b><br>
Prometheus는 메트릭을 수집하고 저장하며, Grafana는 이러한 메트릭을 시각화하는 역할을 합니다.
</details>
