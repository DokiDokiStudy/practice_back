---
title: "11.3 도커 컴포즈를 이용한 빌드 설정"
categoryPath:
  - "Docker"
  - "11장 도커와 도커 컴포즈를 이용한 애플리케이션 빌드 및 테스트"
  - "11.3 도커 컴포즈를 이용한 빌드 설정"
authorNick: "관리자"
createdAt: "2025-08-27"
updateMode: "upsert"
---

# 11.3 도커 컴포즈를 이용한 빌드 설정

## 개요

도커 컴포즈에서 환경변수와 빌드 설정을 활용하여 유연한 CI/CD 파이프라인을 구성하는 방법을 알아본다.

## 환경변수 활용하기

### 기본 문법과 설정

```yaml
services:
  numbers-api:
    image: ${REGISTRY:-docker.io}/diamol/ch11-${BUILD_NUMBER:-local}
    networks:
      - app-net

  web:
    image: ${REGISTRY:-docker.io}/diamol/ch11-${BUILD_NUMBER:-local}
    environment:
      - RngApi__Url=http://web-api/rng
    networks:
      - app-net
```

#### 환경변수 기본값 설정
- `${VARIABLE:-default}` 형식 사용
- 예: `${REGISTRY:-docker.io}`
  - REGISTRY 환경변수가 없으면 docker.io 사용
  - docker.io는 도커 허브 도메인이므로 생략 가능

## 빌드 설정과 레이블

### Dockerfile에서 레이블 사용

```dockerfile
FROM diamol/dotnet-aspnet

ARG BUILD_NUMBER=0
ARG BUILD_TAG=local

LABEL version="3.0"
LABEL build_number=${BUILD_NUMBER}
LABEL build_tag=${BUILD_TAG}

ENTRYPOINT ["dotnet", "Numbers.Api.dll"]
```

#### ARG vs ENV 인스트럭션
- `ARG`: 빌드 시에만 유효한 환경변수
- `ENV`: 컨테이너 실행 시에도 유효한 환경변수
- 레이블은 이미지에 메타데이터를 추가하는 키-값 쌍

### 도커 컴포즈 빌드 설정

```yaml
x-args: &args
  args:
    BUILD_NUMBER: ${BUILD_NUMBER:-0}
    BUILD_TAG: ${BUILD_TAG:-local}
  
services:
  numbers-api:
    build:
      context: numbers
      dockerfile: numbers-api/Dockerfile.v4
      <<: *args

  numbers-web:
    build:
      context: numbers
      dockerfile: numbers-web/Dockerfile.v4
      <<: *args
```

#### 주요 설정 항목
- `context`: 빌드 작업 디렉터리 경로
- `dockerfile`: Dockerfile 스크립트 경로
- `args`: 빌드 시 전달할 인자

## 실행과 검증

```bash
# 이미지 빌드
docker compose -f docker-compose.yml -f docker-compose-build.yml build

# 이미지 레이블 확인
docker image inspect -f '{{.Config.Labels}}' diamol/ch11--local
```

## 이점과 활용

1. **유연한 빌드 환경**
   - 개발 환경과 CI 환경에서 동일한 설정 사용
   - 환경별 적절한 값 자동 적용

2. **추적성 확보**
   - 이미지 레이블로 빌드 이력 관리
   - 실행 중인 컨테이너에서 소스코드 추적 가능

3. **표준화된 빌드 프로세스**
   - 일관된 빌드 환경 제공
   - 팀 전체의 개발 워크플로우 통일

4. **감사 추적**
   - 모든 환경의 컨테이너를 소스코드까지 역추적 가능
   - 보안 및 규정 준수 요구사항 충족