---
title: '컨테이너 속 데이터가 사라지는 이유와 해결 방향'
authorNick: '관리자'
createdAt: '2025-10-15'
updateMode: 'upsert'
---

# 컨테이너 속 데이터가 사라지는 이유와 해결 방향

## 도커와 상태가 있는 애플리케이션의 딜레마

컨테이너는 **무상태 애플리케이션**에게는 최적의 실행 환경이다. 사용량이 증가하더라도 클러스터에 실행중인 컨테이너의 수를 늘리기만 하면 모든 요청이 똑같이 신뢰성 있게 처리된다. 롤링 업데이트를 통하면 서비스 중단 없이 점진적인 업데이트 배포가 가능하다.

다만 **상태가 있는 애플리케이션**의 경우에는 퍼시스턴시나 성능 향상을 위해 디스크를 사용하는 컴포넌트가 있어야 하고, 컴포넌트 역시 컨테이너에서 실행된다. 스토리지가 관련되는 순간 복잡한 상황이 생기는데, 이를 해결하기 위해서 도커 볼륨과 마운트를 사용한다.

---

## 컨테이너 속 데이터가 사라지는 이유

### 컨테이너 파일 시스템의 구조

도커 컨테이너도 단일 드라이브 파일 시스템이 있고, 이는 **이미지 속 파일을 기반으로 만들어진다**. 컨테이너는 모두 독립된 파일 시스템을 갖고, 같은 이미지여도 그 이후에는 디스크의 내용이 달라질 수 있다.

컨테이너의 파일 시스템은 단일 디스크이고, 도커가 여러 출처로부터 합쳐 만들고 컨테이너에 전달한 **가상 파일 시스템**이다. 

### 생애주기의 차이

- **기록 가능 레이어**: 컨테이너와 같은 생애주기를 갖는다
- **이미지 레이어**: 이미지를 내려받은 순간부터 삭제할 때까지 로컬 컴퓨터의 이미지 레이어에 존재한다

이러한 구조적 특성으로 인해 **컨테이너가 종료되면 기록 가능 레이어의 데이터는 모두 사라진다**.

---

## 기록 가능 레이어와 Copy-on-Write 메커니즘

### Copy-on-Write란?

기록 가능 레이어는 기본적으로 **읽기 전용**이지만 도커는 **기록 중 복사(copy-on-write)**라는 방법을 통해서 읽기 전용 레이어의 파일을 수정한다.

### 동작 방식

1. 파일 수정 요청이 들어온다
2. 도커가 해당 파일을 **쓰기 가능 레이어로 복사**한다  
3. 쓰기 가능 레이어에서 파일을 수정한다
4. 이후 해당 파일에 대한 접근은 쓰기 가능 레이어의 파일을 참조한다

### 장점

이 방식을 통해 도커가 **스토리지를 효율적으로 사용**할 수 있다:
- 읽기 전용 레이어는 여러 컨테이너가 공유 가능
- 실제로 수정된 파일만 개별 컨테이너에서 복사본을 관리
- 메모리와 디스크 공간 절약

---

## 해결책의 방향성

컨테이너의 임시적 특성과 데이터 영속성의 요구사항 사이의 갭을 메우기 위해 도커는 다음과 같은 솔루션들을 제공한다:

### 1. **도커 볼륨**
- 컨테이너와 독립적인 생애주기
- 도커가 관리하는 전용 스토리지

### 2. **바인드 마운트**  
- 호스트 파일 시스템과 직접 연결
- 개발 및 데이터 공유에 유용

### 3. **tmpfs 마운트**
- 메모리 기반 임시 스토리지
- 민감한 데이터의 임시 저장

이러한 방법들을 통해 **컨테이너의 장점을 유지하면서도 데이터의 영속성을 보장**할 수 있게 된다.

---

## 실습: 컨테이너 데이터 손실 체험하기

### 실습 6-1: 컨테이너 속 데이터가 사라지는 현상 확인

```bash
# 1. 새로운 컨테이너에서 파일 생성
docker run --name test-data -it alpine:latest sh

# 컨테이너 내부에서 실행
echo "중요한 데이터" > /tmp/important.txt
echo "애플리케이션 로그" > /var/log/app.log
ls -la /tmp/important.txt /var/log/app.log
exit

# 2. 컨테이너를 다시 시작해서 데이터 확인
docker start -i test-data
cat /tmp/important.txt  # 파일이 여전히 존재
cat /var/log/app.log    # 파일이 여전히 존재
exit

# 3. 컨테이너 삭제 후 새 컨테이너로 확인
docker rm test-data
docker run --name test-data-new -it alpine:latest sh
ls /tmp/  # important.txt 없음
ls /var/log/  # app.log 없음
exit
```

**결과**: 컨테이너를 삭제하면 기록 가능 레이어의 모든 데이터가 사라진다!

### 실습 6-2: Copy-on-Write 메커니즘 관찰

```bash
# 1. 베이스 이미지에서 파일 확인
docker run --rm alpine:latest ls -la /etc/passwd

# 2. 파일 수정 시도
docker run --name cow-test alpine:latest sh -c "
echo 'testuser:x:1001:1001::/home/testuser:/bin/sh' >> /etc/passwd &&
cat /etc/passwd | tail -2
"

# 3. 변경사항 확인 (docker diff 사용)
docker diff cow-test
# 출력: C /etc
#       C /etc/passwd

# 4. 정리
docker rm cow-test
```

**설명**: `/etc/passwd` 파일이 수정될 때 Copy-on-Write가 발생하여 기록 가능 레이어로 복사됨

---

## 도커 교과서 핵심 개념

### 컨테이너 파일 시스템의 계층 구조

도커 교과서에 따르면 컨테이너 파일 시스템은 다음과 같이 구성된다:

```
┌─────────────────────┐
│   기록 가능 레이어    │ ← Container Layer (읽기/쓰기 가능)
├─────────────────────┤
│   이미지 레이어 N    │ ← Image Layers (읽기 전용)
├─────────────────────┤
│   이미지 레이어 2    │ ← Image Layers (읽기 전용)  
├─────────────────────┤
│   이미지 레이어 1    │ ← Base Image (읽기 전용)
└─────────────────────┘
```

### 핵심 용어 정리

- **기록 가능 레이어(Container Layer)**: 컨테이너별로 독립적이며, 컨테이너 종료 시 사라짐
- **Copy-on-Write**: 효율적인 스토리지 사용을 위한 도커의 핵심 메커니즘  
- **가상 파일 시스템(Union FileSystem)**: 여러 출처의 파일을 하나의 디스크처럼 보이게 하는 기술
- **생애주기 분리**: 데이터와 컨테이너의 생애주기를 분리하여 영속성 확보

---

## 학습 퀴즈

### 퀴즈 1: 기본 개념 이해
**Q1**: 컨테이너에서 `/app/config.txt` 파일을 수정했을 때, 이 변경사항이 저장되는 위치는?
- A) 이미지 레이어
- B) 기록 가능 레이어  
- C) 호스트 파일 시스템
- D) 도커 데몬

<details>
<summary>정답 보기</summary>
<b>정답: B) 기록 가능 레이어</b><br>
Copy-on-Write 메커니즘에 의해 수정된 파일은 컨테이너의 기록 가능 레이어에 복사되어 저장됩니다.
</details>

### 퀴즈 2: 실무 상황 판단
**Q2**: 다음 중 컨테이너 재시작 후에도 데이터가 유지되는 경우는?
- A) `docker stop` → `docker start`
- B) `docker kill` → `docker start`  
- C) `docker rm` → 새 컨테이너 생성
- D) 호스트 재부팅

<details>
<summary>정답 보기</summary>
<b>정답: A, B) docker stop/kill 후 start</b><br>
컨테이너를 중지했다가 다시 시작하면 기록 가능 레이어가 보존되므로 데이터가 유지됩니다. 하지만 컨테이너를 삭제(rm)하면 모든 데이터가 사라집니다.
</details>

### 퀴즈 3: 문제 해결
**Q3**: 데이터베이스 컨테이너의 데이터를 영구적으로 보존하려면?
- A) 더 큰 이미지 사용
- B) 컨테이너를 절대 재시작하지 않기
- C) 볼륨 또는 바인드 마운트 사용
- D) Copy-on-Write 비활성화

<details>
<summary>정답 보기</summary>
<b>정답: C) 볼륨 또는 바인드 마운트 사용</b><br>
컨테이너와 독립적인 생애주기를 가진 볼륨이나 호스트 디렉터리와 연결하는 바인드 마운트를 사용해야 합니다.
</details>

---

## 핵심 메시지

컨테이너에서 데이터가 사라지는 것은 **버그가 아니라 설계된 동작**입니다. 도커의 철학은 "컨테이너는 일회용"이며, 이를 이해하고 적절한 스토리지 솔루션을 선택하는 것이 성공적인 컨테이너 운영의 핵심입니다.