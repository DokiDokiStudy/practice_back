---
title: "8.1 헬스 체크를 지원하는 도커 이미지 빌드하기"
categoryPath:
  - "Docker"
  - "8장 헬스 체크와 디펜던시 체크로 애플리케이션의 신뢰성 확보하기"
  - "8.1 헬스 체크를 지원하는 도커 이미지 빌드하기"
authorNick: "관리자"
createdAt: "2025-10-26"
updateMode: "upsert"
---

## 헬스 체크의 필요성
- 도커 스웜이나 쿠버네티스의 경우 컨테이너 플랫폼상에서 애플리케이션이 스스로 이상에서 회복할 수 있도록 해 주는 기능을 제공합니다.
- 이미지에 애플리케이션의 상태가 정상인지 확인할 수 있는 정보를 함께 패키징합니다.
- 애플리케이션이 정상적으로 동작하지 않으면, 플랫폼이 비정상 컨테이너를 삭제하고 새 컨테이너로 교체합니다.

# 8.1 헬스 체크를 지원하는 도커 이미지는?
- 컨테이너를 실행시키면 내부에서 특정 프로세스가 실행됩니다.
- 그러나, 해당 프로세스가 실행중이라고 애플리케이션이 정상적인 상태라는 뜻은 아닐 수 있습니다.
- 도커는 애플리케이션의 상태가 정상인지 확인할 수 있는 정보를 도커 이미지에 넣을 수 있습니다.

```bash
$ docker container run -d -p 8080:80 diamol/ch08-numbers-api

# API를 세 번 호출
$ curl 
71

$ curl 
55

$ curl 
9

# 네 번째부터 API 호출 실패.
$ curl 
{"type":"<https://tools.ietf.org/html/rfc7231#section-6.6.1","title":"An> error occured while processing your request.","status":500,"traceId":"|7cf3120a-44d7eeec8760b32c."}%

$ docker container ls
```

- 네번째 부터 500 서버에러를 반환하지만, 컨테이너 상태는 여전히 up 으로 나옵니다.
- 도커 입장에서는 프로세스 내부 애플리케이션의 상태가 정상인지 알 수 있는 방법이 없습니다.

## HEALTHCHECK 인스트럭션
- 위와 같은 상황을 해결하기 위해서 도커는 일정한 시간 간격으로 컨테이너 안에서 HEALTHCHECK 인스트럭션에 정의된 명령을 실행 함으로써 애플리케이션의 상태가 정상인지 확인할 수 있습니다.

```dockerfile
FROM diamol/dotnet-aspnet

ENTRYPOINT ["dotnet", "/app/Numbers.Api.dll"]
HEALTHCHECK CMD curl --fail http://localhost/health

WORKDIR /app
COPY --from=builder /out/ .
```

### 자주 쓰이는 옵션
| 옵션 | 설명 |
|------|------|
| `--interval` | 헬스 체크 주기 (기본 30초) |
| `--timeout` | 명령 실행 제한 시간 |
| `--start-period` | 초기 준비 대기 시간 |
| `--retries` | 실패 허용 횟수 |
| `CMD` | 실행할 명령 (0=정상, 1=비정상) |

- 도커는 이 명령을 주기적으로 실행하고, 반환 코드가 0이 아니면 `unhealthy`로 표시합니다.

```bash
$ cd /ch08/exercises/numbers/numbers-api

$ docker image build -t diamol/ch08-numbers-api:v2 -f ./Dockerfile.v2 . 

$ doker ps

$ curl localhost:8081/rng
$ curl localhost:8081/rng
$ curl localhost:8081/rng

curl localhost:8081/rng
{"type":"<https://tools.ietf.org/html/rfc7231#section-6.6.1","title":"An> error occured while processing your request.","status":500,"traceId":"|609d0306-4c47a4871ee78355."}

$ docker ps

CONTAINER ID   IMAGE                        COMMAND                  CREATED          STATUS                     PORTS                    NAMES
4d1d67dc1cd9   diamol/ch08-numbers-api:v2   "dotnet /app/Numbers…"   2 minutes ago    Up 2 minutes (unhealthy)   0.0.0.0:8081->80/tcp     xenodochial_lehmann
```
- 에러가 발생한 후 컨테이너의 상태 unhealth 확인합니다.
- 컨테이너 이상 상태는 도커 API를 통해 보고됩니다.
- 컨테이너 플랫폼도 컨테이너의 이상 상태를 보고 받아 애플리케이션 복구 조치를 할 수 있습니다.

또한, docker inspect를 통해 가장 최근의 헬스 체크 수행 결과를 확인할 수도 있습니다.
```bash
$ docker container inspect $(docker container ls --last 1 --format '{{.ID}}')
```

## 실습 8-1: Dockerfile에 헬스 체크 추가
```dockerfile
FROM diamol/node
WORKDIR /app
COPY src/ .
ENV MAX_ALLOCATION_MB=4096 LOOP_ALLOCATION_MB=512 LOOP_INTERVAL_MS=2000
CMD ["node", "memory-hog.js"]

HEALTHCHECK --interval=5s CMD node memory-check.js
```

```bash
docker build -t memory-test .
docker run -d --name mem-check memory-test
docker inspect --format='{{.State.Health.Status}}' mem-check
```

**결과:** 일정 주기마다 `memory-check.js`가 실행되어 메모리가 부족하면 `unhealthy`로 표시됩니다.

## 핵심 정리
- 헬스 체크는 컨테이너 내부 애플리케이션의 정상 동작을 주기적으로 점검하여 장애를 빠르게 감지하고 복구할 수 있게 합니다.
- HEALTHCHECK 명령은 0(정상), 1(비정상) 반환값을 기준으로 컨테이너 상태를 healthy/unhealthy로 표시합니다.
- 주기, 타임아웃, 재시도 등 옵션을 적절히 조정해야 시스템 부하와 오탐을 방지할 수 있습니다.
- 상태는 `starting`, `healthy`, `unhealthy` 3단계로 구분되며, docker ps/inspect로 확인 가능합니다.

## 퀴즈

### Q1. HEALTHCHECK 명령이 0이 아닌 값을 반환하면 컨테이너 상태는?
- A) healthy
- B) unhealthy
- C) exited
- D) restarting

<details>
<summary>정답 보기</summary>
<b>정답: B) unhealthy</b><br>
0이 아닌 값을 반환하면 도커는 컨테이너 상태를 `unhealthy`로 표시합니다.
</details>

### Q2. HEALTHCHECK의 주기를 너무 짧게 설정하면 발생할 수 있는 문제는?
- A) 장애 감지 지연
- B) 시스템 부하 증가
- C) 컨테이너 자동 삭제
- D) 상태 확인 불가

<details>
<summary>정답 보기</summary>
<b>정답: B) 시스템 부하 증가</b><br>
너무 잦은 healthcheck는 CPU/I/O 부하를 유발할 수 있습니다.
</details>