---
title: "8.3 애플리케이션 체크를 위한 커스텀 유틸리티 만들기"
categoryPath:
  - "Docker"
  - "8장 헬스 체크와 디펜던시 체크로 애플리케이션의 신뢰성 확보하기"
  - "8.3 애플리케이션 체크를 위한 커스텀 유틸리티 만들기"
authorNick: "관리자"
createdAt: "2025-08-27"
updateMode: "upsert"
---

# 애플리케이션 체크를 위한 커스텀 유틸리티 도입 및 도커 컴포즈에서 헬스 체크와 디펜던시 활용하기

## curl 을 이미지에 포함시키지 않는 이유와 문제점
- 실무에서는 보안 정책 등 여러 가지 이유로 이미지에 curl 을 포함시킬 수 없기 때문에 curl 을 사용하지 않습니다.
- 보안
  - curl 은 네트워크 요청을 보내는 도구로, 잘못된 사용 시 보안 취약점 노출 가능합니다.
  - 특히, HEALTHCHECK 는 컨테이너 내부에서 실행되기 때문에, 공격자가 이를 악용하여 컨테이너 데이터 유출 혹은 공격 가능합니다.
- 안정성
  - curl 을 이용한 HEALTHCHECK 는 네트워크 상태, 타 서비스의 응답 속도 등 외부 요인에 영향을 받기 쉽습니다.
  - 이로 인해 서비스가 정상적으로 작동하고 있음에도 HEALTHCHECK 가 실패할 수 있습니다.
- 이미지의 크기
  - curl 은 이미지의 크기를 불필요하게 증가시킵니다.
  - 특히, 여러 레이러를 사용하는 복잡한 이미지의 경우 문제가 있을 수 있습니다.
  - 또한, 모든 이미지에 curl 이 반드시 필요한 것은 아니므로 불필요한 자원이 낭비가 됩니다.


## 커스텀 유틸리티의 장점
커스텀 유틸리티는 애플리케이션과 같은 언어로 구현한 애플리케이션 체크 도구입니다. 커스텀 유틸리티를 사용하는 주요 장점은 다음과 같습니다.
- 애플리케이션과 같은 도구를 사용하므로 이미지에 추가적인 소프트웨어를 포함시킬 필요가 없습니다.
- 쉘 스크립트로 표현하기 까다로운 복잡한 로직을 사용할 수 있습니다.
- 애플리케이션과 같은 설정을 사용해. 반복 정의 사용및 수정 누락 등을 방지할 수 있습니다.
- 애플리케이션과 동일한 환경에서의 실행 전 확인이 필요한 모든 사항을 검증할 수 있습니다.


```dockerfile
FROM diamol/dotnet-aspnet

ENTRYPOINT ["dotnet", "Numbers.Api.dll"]
HEALTHCHECK CMD ["dotnet", "Utilities.HttpCheck.dll", "-u", "<http://localhost/health>"]

WORKDIR /app
COPY --from=http-check-builder /out/ .
COPY --from=builder /out/ .
```

```dockerfile
FROM diamol/dotnet-aspnet

ENV RngApi:Url=http://numbers-api/rng

CMD dotnet Utilities.HttpCheck.dll -c RngApi:Url -t 900 && \\
    dotnet Numbers.Web.dll
WORKDIR /app
COPY --from=http-check-builder /out/ .
COPY --from=builder /out/ .
```


## 도커 컴포즈에 헬스 체크와 디펜던시 체크 정의하여 활용하기
- 도커 컴포즈는 애플리케이션의 상태에 이상이 생겼을 때 어느 정도 복원할 수 있는 기능이 있습니다.
- 그러나, 도커 컴포즈는 이상이 생긴 컨테이너를 새로운 컨테이너로 교체하지 않습니다.
- 새로운 컨테이너로 교체 과정 중에 더 큰 장애가 발생할 수 있기 때문입니다.
- 도커 컴포즈 파일에서는 헬스 체크의 옵션을 더 세세하게 설정할 수 있습니다.

```yaml
numbers-api:
	image: diamol/ch08-numbers-api:v3
	restart: on-failure
	ports:
		- "8080:80"
	healthcheck:
		test: ["CMD", "dotnet", "Utilites.HttpCheck.dll", "-t", "150"]
		interval: 5s
		timeout: 1s
		retries: 2
		start_period: 5s
	networks:
		- app-net
```

- test : 헬스체크를 위한 명령어.
- restart : 컨테이너 종료시 재시작 관련 옵션

```bash
$ docker compose up -d

WARN[0000] networks.app-net: external.name is deprecated. Please set name and external: true 
[+] Running 13/13
 ✔ numbers-web Pulled                                                                                                                                                                                  6.1s 
   ✔ 2c6f18abfee2 Pull complete                                                                                                                                                                        2.0s 
   ✔ c8933103e3d5 Pull complete                                                                                                                                                                        2.2s 
   ✔ fae779850b6e Pull complete                                                                                                                                                                        2.8s 
 ✔ numbers-api Pulled                                                                                                                                                                                  4.9s 
   ✔ f338bc35613f Already exists                                                                                                                                                                       0.0s 
   ✔ 5636d912c69e Already exists                                                                                                                                                                       0.0s 
   ✔ 362df8b85fca Already exists                                                                                                                                                                       0.0s 
   ✔ 24c3992ceef4 Already exists                                                                                                                                                                       0.0s 
   ✔ 546a81dfea0f Already exists                                                                                                                                                                       0.0s 
   ✔ a1d31c83c9fb Pull complete                                                                                                                                                                        1.1s 
   ✔ b4b21f2c15f2 Pull complete                                                                                                                                                                        1.6s 
   ✔ 5b2370cbc2a2 Pull complete                                                                                                                                                                        1.6s 
[+] Running 2/2
 ✔ Container numbers-numbers-api-1  Started                                                                                                                                                            0.3s 
 ✔ Container numbers-numbers-web-1  Started         
 
$ docker ps
CONTAINER ID   IMAGE                        COMMAND                  CREATED          STATUS                                     PORTS                                     NAMES
a27d8181cf94   diamol/ch08-numbers-web:v3   "/bin/sh -c 'dotnet …"   7 seconds ago    Up Less than a second (health: starting)   0.0.0.0:8088->80/tcp, [::]:8088->80/tcp   numbers-numbers-web-1
25079f8a8819   diamol/ch08-numbers-api:v3   "dotnet Numbers.Api.…"   7 seconds ago    Up 6 seconds (healthy)                     0.0.0.0:8087->80/tcp, [::]:8087->80/tcp   numbers-numbers-api-1
26e8b5893314   diamol/ch08-numbers-web      "dotnet /app/Numbers…"   47 minutes ago   Up 47 minutes                              0.0.0.0:8082->80/tcp, [::]:8082->80/tcp   infallible_maxwell

$ docker logs numbers-numbers-web-1
HTTPCheck: status OK, url <http://numbers-api/rng>, took 5098ms
HTTPCheck: status OK, url <http://numbers-api/rng>, took 39ms
```

### 헬스 체크와 디펜던시 체크를 사용하여 복원력 있는 애플리케이션을 만들 수 있는 이유는?
- dependency 와 healthcheck 를 사용하면, 플랫폼이 실행 순서를 보장하게 할 필요가 없습니다
- 의존관계를 만족하지 못한 상태의 경우 설정에 따라 재실행되거나 다른 컨테이너로 교체될 것입니다.
- 자가 수복이란 일시적인 오류를 플랫폼이 해소해주는 것입니다.

### 주의사항
| 항목 | 설명 |
|------|------|
| **과도한 주기** | 체크 주기가 너무 짧으면 CPU와 I/O 부하가 증가합니다. |
| **복잡한 검사 로직** | 복잡한 로직은 false positive/negative를 유발할 수 있습니다. |
| **외부 네트워크 의존** | 외부 API를 healthcheck로 호출하면 네트워크 불안정 시 오탐지 발생이 가능합니다. |
| **디펜던시 과잉 설정** | 체인형 depends_on이 많을수록 관리 복잡도가 상승합니다. |


### 안전한 애플리케이션 구현 시 트러블슈팅 가이드
| 문제 상황 | 원인 | 해결 방법 |
|------------|------|------------|
| depends_on이 작동 안 함 | healthcheck 미정의 | healthcheck 추가 및 테스트 필요 |
| 컨테이너가 너무 빨리 시작 | 대기 로직 누락 | 커스텀 유틸리티 작성 또는 start_period 조정 |
| CPU 부하 발생 | 체크 주기 과도 | interval, retries 값 완화 |

### 장애 대응을 위한 설계 팁
1. **빠른 실패(Fail Fast)**
  - 서비스가 정상 상태가 아닐 경우 즉시 실패 코드를 반환하도록 설계.
2. **상태 엔드포인트 분리**
  - `/health`: 단순 프로세스 생존 여부
  - `/ready`: 외부 서비스 연결 여부 (DB, API 등)
3. **로깅 및 모니터링 통합**
  - healthcheck 로그를 수집해 장애 발생 패턴을 분석.
4. **자동 재시작 정책 연동**
  - `restart: always` 또는 `on-failure` 옵션과 함께 사용해 복구력을 높이는 것이 좋습니다.

```yaml
services:
  web:
   image: my-app:latest
   healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost/health"]
    interval: 10s
    retries: 3
   restart: on-failure
```

## 핵심 정리

- healthcheck와 depends_on을 적절히 활용하면 장애 복구, 서비스 기동 순서 보장, 운영 자동화에 큰 도움이 됩니다.
- 과도한 healthcheck 주기, 복잡한 검사 로직, 외부 네트워크 의존 등은 오히려 장애 탐지 지연이나 시스템 부하를 유발할 수 있습니다.
- `/health`, `/ready` 등 단순한 내부 엔드포인트로 체크를 수행하는 것이 가장 안정적입니다.
- 자동 재시작 정책(restart: always/on-failure)과 연동하면 복구력을 높일 수 있습니다.

## 퀴즈
### Q1. healthcheck 명령에서 외부 API를 직접 호출하는 것이 바람직하지 않은 이유는?
- A) 네트워크 불안정 시 오탐지 발생 가능
- B) 컨테이너가 자동 삭제됨
- C) healthcheck가 비활성화됨
- D) 컨테이너 이름이 변경됨

<details>
<summary>정답 보기</summary>
<b>정답: A) 네트워크 불안정 시 오탐지 발생 가능</b><br>
외부 API는 네트워크 변수로 인해 healthcheck의 신뢰성을 떨어뜨릴 수 있습니다.
</details>

### Q2. 다음 중 healthcheck/depends_on을 잘못 사용할 때 발생할 수 있는 문제는?
- A) 서비스 지연
- B) 시스템 부하 증가
- C) 장애 감지 실패
- D) 모두 해당

<details>
<summary>정답 보기</summary>
<b>정답: D) 모두 해당</b><br>
과도한 healthcheck, 잘못된 depends_on 설정은 서비스 지연, 부하, 장애 감지 실패 등 다양한 문제를 유발할 수 있습니다.
</details>