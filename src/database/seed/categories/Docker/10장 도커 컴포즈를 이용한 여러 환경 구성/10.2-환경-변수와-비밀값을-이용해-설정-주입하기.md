---
title: "10.2 환경 변수와 비밀값을 이용해 설정 주입하기"
categoryPath:
  - "Docker"
  - "10장 도커 컴포즈를 이용한 여러 환경 구성"
  - "10.2 환경 변수와 비밀값을 이용해 설정 주입하기"
authorNick: "관리자"
createdAt: "2025-08-27"
updateMode: "upsert"
---

# 10.2 환경 변수와 비밀값을 이용해 설정 주입하기
- 도커 컴포즈는 각 컨테이너에 필요한 환경 변수와 비밀값을 설정하여 애플리케이션을 유연하게 운영할 수 있습니다.
- 환경 변수는 컨테이너 실행 시점에 설정할 수 있으며, 애플리케이션의 동작 방식을 제어하는 데 사용됩니다.

```yaml
# docker-compose.yml
services:
	todo-web:
		image: diamol/ch06-todo-list
		secrets:
			- source: todo-db-connection
			  target: /app/config/secrets.json
```
- source: 원본 위치, 컨테이너 런타임이 비밀값을 읽어오는 곳입니다.
- target: 컨테이너 내부에 비밀값이 위치할 경로를 뜻합니다.

```yaml
# docker-compose-dev.yml
# 개발 환경만을 위한 추가 설정과 비밀값이 정의된 오버라이드 파일
services:
	todo-web:
		ports:
			- 8089:80
		environment:
			- Database:Provider=Sqlite
		env_file:
			- ./config/logging.debug.env
secrets:
	todo-db-connection:
		file: ./config/empty.json
```

- environment
  - 컨테이너 안에서만 사용되는 환경 변수를 추가합니다.
- env_file
  - 텍스트 파일의 경로를 값으로 받습니다.
  - 이 파일에 정의된 환경 변수가 컨테이너에 적용됩니다.
  - 텍스트 파일에 변수 이름과 값을 등호로 구분해 한 줄에 하나씩 정의합니다.
- secrets
  - 컴포즈 파일의 최상위 프로퍼티
  - todo-db-connection의 실제 값 혹은 경로가 정의됩니다.
			
```bash
$ docker compose -f ./todo-list-configured/docker-compose.yml -f ./todo-list-configured/docker-compose-dev.yml -p todo-dev up -d

Creating network "todo-dev_default" with the default driver
Creating todo-dev_todo-web_1 ... done
```

- 도커 컴포즈는 애플리케이션 한 개마다 도커 네트워크를 하나씩 사용하므로 컴포즈 파일에 정의된 네트워크가 없어도 기본 네트워크에 컨테이너를 연결합니다.

## Docker 기본 네트워크 (bridge)
- 도커 컴포즈는 애플리케이션의 여러 서비스 간의 네트워킹을 쉽게 설정하고 관리할 수 있는 도구입니다.
- Docker 는 기본적으로 모든 컨테이너를 연결하는 bridge 라는 가상 네트워크를 생성합니다.
- bridge 는 도커 데몬이 관리하는 가상 네트워크로, 동일한 브리지 네트워크에 연결된 컨테이너들은 서로 IP 주소를 통해 통신합니다.
- 또한, bridge 네트워크는 외부 네트워크와 격리되어 있어 보안을 강화할 수 있습니다.
- 컴포즈 파일에서 네트워크를 명시적으로 정의하지 않으면, Docker 는 기본 네트워크를 사용하여 컨테이너를 연결합니다.

### 호스트 컴퓨터의 환경 변수를 컨테이너에 전달하기
```yaml
todo-web:
	ports:
		- "$(TODO_WEB_PORT):80"
	environment:
		- Database:Provider=Postgres
	env_file:
		- ./config/logging.information.env
	networks:
		- app-net
```

```bash
$ vi .env

TODO_WEB_PORT=8877
TODO_DB_PORT=5432

COMPOSE_PATH_SEPARATOR=;
COMPOSE_FILE=docker-compose.yml;docker-compose-test.yml
COMPOSE_PROJECT_NAME=todo_ch10
```
- .env 파일을 사용하면 docker-compose.yml 파일을 수정하지 않고, 설정값을 변경할 수 있기 때문에 애플리케이션의 이식성이 향상 됩니다.
- env_file 키를 사용하여 외부 파일에서 환경 변수를 읽어 올 수 있습니다.
- 컴포즈 파일에서 $ 기호를 사용하여 환경 변수를 참조할 수 있습니다.
- 컴포즈 파일과 동일한 디렉토리에서 .env 파일을 생성 및 정의하여, 컴포즈는 해당 파일을 자동으로 읽어들입니다.

## 확장 필드로 중복 제거하기
- 확장 필드는 앵커(&)와 병합(<<:) 문법을 활용해 공통 설정을 재사용하는 방법입니다.
- 도커 컴포즈를 사용하다보면 서비스 간 많은 설정값을 공유하는 컴포즈 파일의 덩치가 점점 커지는 것이 문제입니다.
- 이런 문제를 해결하기 위해 확장 필드를 사용할 수 있습니다.
- 확장 필드는 컴포즈 파일을 관리하는 베스트 프렉티스 중 한가지 방법입니다.
- 확장 필드를 잘 사용할 경우 중복되는 설정을 상당부분 재사용할 수 있습니다.
- 하지만, 확장 필드에도 여러 컴포즈 파일에 한꺼번에 적용할 수 없습니다.
- 따라서, 코어 컴포즈 파일에 정의된 확장 필드를 오버라이드 파일에서 사용할 수는 없습니다.

```yaml
version: "3.7"

x-labels: &logging
  logging:
    options:
      max-size: '100m'
      max-file: '10'

x-labels: &labels
  app-name: image-gallery

services:
  accesslog:
    <<: *logging
    labels:
      <<: *labels

  iotd:
    ports:
      - 8080:80
    <<: *logging
    labels:
      <<: *labels
      public: api

  image-gallery:
    ports:
      - 80:80
    <<: *logging
    labels:
      <<: *labels
      public: web

  prometheus:
    image: diamol/ch09-prometheus
    ports:
      - "9090:9090"
    environment:
```

- 도커 컴포즈의 확장 필드는 앰퍼샌드 문법을 사용합니다.
- <<:* 위치에 해당 YAML 파일의 확장 필드값이 병합됩니다.

```bash
$ docker-compose -f ./image-gallery/docker-compose.yml -f ./image-gallery/docker-compose-prod.yml config

WARN[0000] /home/gwanii/docker_textbook/080258-main/ch10/exercises/image-gallery/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
WARN[0000] The "HOST_IP" variable is not set. Defaulting to a blank string. 
WARN[0000] /home/gwanii/docker_textbook/080258-main/ch10/exercises/image-gallery/docker-compose-prod.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
```

```yaml
name: image-gallery
services:
  accesslog:
    image: diamol/ch09-access-log
    labels:
      app-name: image-gallery
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
  grafana:
    depends_on:
      prometheus:
        condition: service_started
        required: true
    image: diamol/ch09-grafana
    labels:
      app-name: image-gallery
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
      - mode: ingress
        target: 3000
        published: "3000"
        protocol: tcp
  image-gallery:
    image: diamol/ch09-image-gallery
    labels:
      app-name: image-gallery
      public: web
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
      - mode: ingress
        target: 80
        published: "80"
        protocol: tcp
  iotd:
    image: diamol/ch09-image-of-the-day
    labels:
      app-name: image-gallery
      public: api
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
      - mode: ingress
        target: 80
        published: "8080"
        protocol: tcp
  prometheus:
    environment:
      DOCKER_HOST: ""
    image: diamol/ch09-prometheus
    labels:
      app-name: image-gallery
    logging:
      options:
        max-file: "10"
        max-size: 100m
    networks:
      app-net: null
    ports:
      - mode: ingress
        target: 9090
        published: "9090"
        protocol: tcp
networks:
  app-net:
    name: image-gallery-prod
x-labels:
  app-name: image-gallery
x-logging:
  logging:
    options:
      max-file: "10"
      max-size: 100m
```

- 위에 나와있는 예제를 따라할 경우 아래와 같은 에러가 발생할 것입니다.
```bash
WARN[0000] /home/gwanii/docker_textbook/080258-main/ch10/exercises/image-gallery/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion 
yaml: unmarshal errors:
  line 9: mapping key "x-labels" already defined at line 3
```
- Docker Compose V2 버전부터는 x-fileds 가 중복으로 선언되는 것이 불가능합니다.
- 정확히는 사용할 수는 있지만, 권장되지 않는다고 합니다.
- 그 이유는 유지보수 차원에서 확장 필드를 명확히 분리하는 방식 사용을 권장합니다.

### 확장 필드 수정 예시
```yaml
x-common: &common
  logging:
    options:
      max-size: "100m"
      max-file: "10"
  labels:
    app-name: image-gallery

services:
  accesslog:
    <<: *common
  iotd:
    <<: *common
    labels:
      app-name: image-gallery
      public: api
  image-gallery:
    <<: *common
    labels:
      app-name: image-gallery
      public: web
```
- 이렇게 하면 중복된 x-labels 정의 없이 “로깅 + 라벨”을 함께 묶은 공통 블록으로 재사용 가능하며, Compose V2에서도 경고 없이 작동합니다.

## 퀴즈

### Q1. Docker Compose에서 `env_file`의 주요 역할은?
- A) 로그 파일을 지정한다
- B) 환경 변수를 외부 파일로부터 불러온다
- C) 비밀값을 암호화한다
- D) .NET 앱의 설정 파일을 만든다
<details><summary>정답 보기</summary>
<b>정답: B) 환경 변수를 외부 파일로부터 불러온다</b><br>
env_file은 텍스트 파일에서 환경 변수를 읽어와 컨테이너에 주입합니다.
</details>

### Q2. Docker Compose에서 `.env` 파일과 `env_file`의 차이로 올바른 것은?
- A) 둘 다 자동으로 로드된다
- B) .env는 디렉토리 전역, env_file은 서비스별로 지정 가능하다
- C) env_file이 .env보다 우선순위가 높다
- D) 둘 다 수동으로 지정해야 한다
<details><summary>정답 보기</summary>
<b>정답: B) .env는 디렉토리 전역, env_file은 서비스별로 지정 가능하다</b>
</details>

### Q3. Docker Compose의 확장 필드(x-field)를 사용하는 이유는?
- A) 중복 코드를 줄이고 여러 서비스 간 공통 설정을 재사용하기 위해서
- B) 비밀값을 암호화하기 위해서
- C) .env 파일을 자동 생성하기 위해서
- D) Compose 버전을 명시하기 위해서
<details><summary>정답 보기</summary>
<b>정답: A) 중복 코드를 줄이고 여러 서비스 간 공통 설정을 재사용하기 위해서</b>
</details>